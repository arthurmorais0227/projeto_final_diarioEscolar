<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memórias</title>
  <link rel="stylesheet" href="/assets/styles/memorias.css" />
  <link rel="stylesheet" href="/assets/styles/responsive.css" />
  <link rel="icon" href="/assets/img/logo_claro.png" type="image/png">
</head>

<body>
  <header>
    <div class="marca">
      <img src="/assets/img/logo_claro.png" alt="Logo dos Sitecrafters pixada com gotas de tinta na parede"
        height="200" />
    </div>
    <div class="menu">
      <div class="icones"></div>
      <a href="/index.html" class="menu-link">Início</a>
      <a href="/pages/memorias.html" class="menu-link">Memórias</a>
      <a href="/pages/alunos.html" class="menu-link">Alunos</a>
      <a href="/pages/docentes.html" class="menu-link login-link">Docentes</a>
      <a href="/pages/login.html" class="menu-link">Login</a>
    </div>
  </header>

  <main>
    <div class="memorias_pai">



      <div class="memorias">

        <div class="memorias_titulo">
          <h1>Mural de Memórias</h1>
          <div class="criar_memoria">
            <button>+ Criar Memória</button>
          </div>
        </div>

        <!-- Container que será preenchido via JS com as memórias do back-end -->
        <div id="memoriasList" class="memorias_list" aria-live="polite">
          <!-- items serão injetados aqui -->
        </div>

      </div>
    </div>
  </main>
  <div class="popup" id="popupCriar">
  <div class="popup-conteudo">
    <span class="popup-fechar" id="fecharPopup">&times;</span>

    <h2>Criar Memória</h2>

    <label>Imagem:</label>
    <input type="file" id="inputImagem" accept="image/*">

    <!-- PREVIEW -->
    <img id="previewImagem" style="display:none; width: 150px; margin-top: 10px; border-radius: 10px;">

    <label>Descrição (100 caracteres):</label>
    <textarea id="descricao" placeholder="Digite uma descrição..." maxlength="100"></textarea>
    <p id="contadorDesc">0/100</p>

    <button class="popup-salvar" id="salvarMemoria">Salvar</button>
  </div>
</div>

  <script src="./../assets/js/script.js"></script>
  <script>
    // Busca memórias do back-end e renderiza no DOM, mostrando tempo relativo desde a postagem
    document.addEventListener('DOMContentLoaded', () => {
      const list = document.getElementById('memoriasList');

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      async function loadMemorias() {
        try {
          // Tenta buscar o endpoint em várias portas comuns (3001, 3000) para tolerância
          const candidateUrls = [
            'http://localhost:3001/postagens',
            'http://localhost:3000/postagens',
            `${location.protocol}//${location.hostname}:3001/postagens`,
            `${location.protocol}//${location.hostname}:3000/postagens`
          ];

          let resp = null;
          let lastError = null;
          for (const url of candidateUrls) {
            try {
              resp = await fetch(url);
              if (resp && resp.ok) {
                break;
              }
              // se não ok, guardar erro e tentar próximo
              lastError = new Error('Status ' + (resp ? resp.status : 'no-response') + ' from ' + url);
            } catch (e) {
              lastError = e;
            }
          }

          if (!resp) throw lastError || new Error('Nenhuma resposta do servidor');
          if (!resp.ok) throw new Error('Erro ao buscar postagens: ' + resp.status);
          const data = await resp.json();
          const posts = data.postagens || [];

          list.innerHTML = '';

          if (posts.length === 0) {
            list.innerHTML = '<p>Nenhuma memória encontrada.</p>';
            return;
          }

          posts.forEach(post => {
            const record = document.createElement('div');
            record.className = 'recordacao';

            const autor = escapeHtml(post.autor || 'Autor desconhecido');
            const descricao = escapeHtml(post.descricao || '');
            // imagem: assume que o campo contém uma URL ou caminho utilizável
            const imagemSrcRaw = post.imagem || '';
            // Normalizar src da imagem:
            // - se já for URL absoluta (http/https) ou começar com '/', usa direto
            // - se for apenas um nome de ficheiro, tenta a pasta /assets/img/banco_fotos2/
            let imagemSrc = imagemSrcRaw;
            try {
              if (imagemSrcRaw && !/^(https?:)?\/\//i.test(imagemSrcRaw) && !imagemSrcRaw.startsWith('/')) {
                imagemSrc = '/assets/img/banco_fotos2/' + imagemSrcRaw;
              }
              // garantir que começa com '/' ou 'http'
              if (imagemSrc && !imagemSrc.startsWith('/') && !/^https?:/i.test(imagemSrc)) {
                imagemSrc = '/' + imagemSrc;
              }
            } catch (e) {
              console.warn('Erro ao normalizar imagem:', imagemSrcRaw, e);
              imagemSrc = imagemSrcRaw;
            }
            console.debug('Imagem resolvida para postagem', post.id, imagemSrcRaw, '->', imagemSrc);

            record.innerHTML = `
              <div class="recordacao_titulo">
                <div class="autor"><h3>${autor}</h3></div>
              </div>
              <div class="imagem_recordacao">
                <img src="${escapeHtml(imagemSrc)}" alt="imagem da recordação" onerror="this.onerror=null;this.src='/assets/img/myschooldiary.png'">
              </div>
              <div class="descricao"><p>${descricao}</p></div>
            `;

            list.appendChild(record);
          });

        } catch (err) {
          console.error(err);
          const msg = err && err.message ? err.message : String(err);
          const stack = err && err.stack ? err.stack : '';
          list.innerHTML = `
            <div class="erro_carregamento">
              <p>Erro ao carregar memórias: ${escapeHtml(msg)}</p>
              <details style="white-space:pre-wrap; margin-top:8px;"><summary>Detalhes (stack)</summary>${escapeHtml(stack)}</details>
              <p>Tente reiniciar o back-end e recarregar a página (F5).</p>
            </div>
          `;
        }
      }

      loadMemorias();
    });
  </script>
</body>

</html>